マルウェア動作検証およびシグネチャ作成
=============

環境構築手順
-------

### 手順1

PCを３台（もしくは４台）とIPSと有線ケーブルを３本用意する。

### 手順2

PCの役割を決める。今回は以下のとおりに設定した。
- ① アナリストチーム検証用：ルーター用
- ② アナリストチーム検証機 #1：VM上でマルウェアを感染させる用のPC
- ③ Monitoring機器；Security Alertログを見たり、User Definedを作成したりするためのPC
- ④ 感染PC：実機でマルウェアを感染させる用のPC

### 手順3

IPSに有線ケーブルを繋ぐ。以下を参照にして繋いでください。

- ①→"PROTECTED"
- ②→"PROTECTED"
- ③→"MANAGEMENT"

### 手順4

IPSとPCを起動させる。

### 手順5

①のPCを設定する。
	1.モバイルルーターを接続させる。
	2.ネットワークの設定をする。以下設定方法。
	[ネットワークと共有センター]→[アダプターの設定の変更]→[ワイヤレスネットワーク接続]→[プロパティ]→[共有]→接続を許可するのチェックボックスの所にチェックを入れる

### 手順6

②のPCを設定する。

1. VM上と共有するためのフォルダーとローカルに保存するためのフォルダーを作成する。
2. VM VirtualBoxを起動して共有できるよう設定する。以下設定方法。
		自分が起動したいものをクリック→[設定]をクリック→[共有フォルダー]をクリック→フォルダーリスト内の共有フォルダを右クリック
		→[共有フォルダーを追加]→パス名を入力し自動マウントにチェック→出来上がり
3. マルウェアに感染しても綺麗な状態にすぐ戻せるようスナップ写真を作成しておく。以下作成方法。
		[最新の状態]を選択→カメラアイコンをクリック→出来上がり
4. 起動してtestアカウント(PW:abc123)でログインして検証を始める。
	
### 手順7

③のPCを設定する。
	1.https://192.168.50.100に接続する。(今回はFirefoxで)
	2.ID:admin PW:abc123で認証する。
	3.接続する、ブロックしないと選択していけばモニタリングできる。

検証手順
-------


### 手順1

自分が欲しいマルウェアの検体そのもの、もしくはハッシュ値を用意し、VirusTotal(https://www.virustotal.com/ja/)にログインしてダウンロードする。

※今回は水谷さんのアカウントを拝借させていただきました。ちなみにこの中でログインできるのIBM社員のみ。

### 手順2

ダウンロードしたファイルを作成した共有フォルダー(20150814_intern)と、ローカルに保存するためのフォルダー(Malware検証_intern)にコピーする。
20150814_intern：ローカルとVM上でファイルを共有するためのフォルダー
Malware検証_intern：マルウェアによって20150814_intern上のファイルが全部消えたり暗号化されたりしたときに備えたバックアップ用フォルダー

### 手順3

事前に感染していないクリーンな状態のスナップショットが作成されていることを確認してからそのスナップショットを起動する。

### 手順4

共有フォルダー(20150814_intern)を開きマルウェアのファイルをVM上のデスクトップに移す。

### 手順5

デスクトップに置いたマルウェアのファイル名を変更する。
	※名前は何でもいいが拡張子は必ず「.exe」にする。
	
### 手順6

Wiresharkを起動してパケットキャプチャーがちゃんと開始されているかを確認してからマルウェアを動かす。

### 手順7

ログを見てマルウェアが落ち着いてきたなと感じたらWiresharkのログデータを共有フォルダーに保存し、ローカルで見ることができるか確認する。

### 手順8

確認できたらVM上のWindowsをシャットダウンして、スナップショットを復元する。

※必ず「現在のマシンの状態のスナップショットを作成」のチェックボックスからチェックをはずす。

連続して検証する際はこれを繰り返す。


記録方法
---------

- `report/(ハッシュ値).md` のファイルを作成し検証に関するまとめを記述してください
- `report/(ハッシュ値).pcap` のファイル名で通信データの記録を保存してください

例)

- `report/15c926d2602f65be0de65fa9c06aa6c6.md`
- `pcap/15c926d2602f65be0de65fa9c06aa6c6.pcap`
